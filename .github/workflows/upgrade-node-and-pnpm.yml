# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: upgrade-node-and-pnpm
on:
  workflow_dispatch: {}
  schedule:
    - cron: 0 0 1 * *
jobs:
  upgrade:
    name: Upgrade
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    outputs:
      patch_created: ${{ steps.create_patch.outputs.patch_created }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: main
      - name: Get latest NodeJS versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: "gh api -H \"Accept: application/vnd.github+json\" -H \"X-GitHub-Api-Version: 2022-11-28\" /repos/nodejs/node/releases --jq '{\"node20\": (map(select(.tag_name | startswith(\"v20.\"))) | sort_by(.tag_name) | reverse | map({version: .tag_name})[0]), \"node22\": (map(select(.tag_name | startswith(\"v22.\"))) | sort_by(.tag_name) | reverse | map({version: .tag_name})[0]), \"node24\": (map(select(.tag_name | startswith(\"v24.\"))) | sort_by(.tag_name) | reverse | map({version: .tag_name})[0])}' > src/github/nodejs.json"
      - name: Get latest PNPM
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: "gh api -H \"Accept: application/vnd.github+json\" -H \"X-GitHub-Api-Version: 2022-11-28\" /repos/pnpm/pnpm/releases --jq 'map({version: .tag_name})[0]' > src/github/pnpm.json"
      - name: Upgrade GitHub Actions and NCU
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx ts-node scripts/upgrade-github-versions.ts
      - name: Upgrade Go and golangci-lint
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx ts-node scripts/upgrade-go-versions.ts
      - name: Find mutations
        id: create_patch
        run: |-
          git add .
          git diff --staged --patch --exit-code > repo.patch || echo "patch_created=true" >> $GITHUB_OUTPUT
        shell: bash
        working-directory: ./
      - name: Upload patch
        if: steps.create_patch.outputs.patch_created
        uses: actions/upload-artifact@v4.6.2
        with:
          name: repo.patch
          path: repo.patch
          overwrite: true
  pr:
    name: Create Pull Request
    needs: upgrade
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: ${{ needs.upgrade.outputs.patch_created }}
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@3ff1caaa28b64c9cc276ce0a02e2ff584f3900c5
        with:
          app-id: ${{ secrets.PROJEN_APP_ID }}
          private-key: ${{ secrets.PROJEN_APP_PRIVATE_KEY }}
      - name: Checkout
        uses: actions/checkout@v5
      - name: Download patch
        uses: actions/download-artifact@v5
        with:
          name: repo.patch
          path: ${{ runner.temp }}
      - name: Apply patch
        run: '[ -s ${{ runner.temp }}/repo.patch ] && git apply ${{ runner.temp }}/repo.patch || echo "Empty patch. Skipping."'
      - name: Set git identity
        run: |-
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.generate_token.outputs.token }}
          commit-message: |-
            chore(deps): upgrade NodeJS, PNPM and other versions

            Upgrades NodeJS (latest versions for Node.js 20, 22, and 24), PNPM, GitHub Actions hashes and other tool versions. See details in [workflow run].

            [Workflow Run]: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ------

            *Automatically created by projen via the "upgrade-node-and-pnpm" workflow*
          branch: github-actions/upgrade-node-and-pnpm
          title: "chore(deps): upgrade NodeJS, PNPM and other versions"
          labels: dependencies
          body: |-
            Upgrades NodeJS (latest versions for Node.js 20, 22, and 24), PNPM, GitHub Actions hashes and other tool versions. See details in [workflow run].

            [Workflow Run]: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ------

            *Automatically created by projen via the "upgrade-node-and-pnpm" workflow*
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          signoff: true
